name: Release

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:

env:
  CARGO_TERM_COLOR: always

jobs:
  build-deb:
    name: Build Debian Package
    runs-on: ubuntu-24.04
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            libgtk-4-dev \
            libvte-2.91-gtk4-dev \
            libadwaita-1-dev \
            libdbus-1-dev \
            libssl-dev \
            pkg-config \
            debhelper \
            devscripts

      - name: Build release binary
        run: cargo build --release -p rustconn -p rustconn-cli

      - name: Create deb package structure
        run: |
          VERSION=$(grep '^version' Cargo.toml | head -1 | sed 's/.*"\(.*\)"/\1/')
          PKG_DIR="rustconn_${VERSION}_amd64"
          
          mkdir -p "${PKG_DIR}/DEBIAN"
          mkdir -p "${PKG_DIR}/usr/bin"
          mkdir -p "${PKG_DIR}/usr/share/applications"
          mkdir -p "${PKG_DIR}/usr/share/metainfo"
          mkdir -p "${PKG_DIR}/usr/share/icons/hicolor/scalable/apps"
          mkdir -p "${PKG_DIR}/usr/share/icons/hicolor/256x256/apps"
          mkdir -p "${PKG_DIR}/usr/share/icons/hicolor/128x128/apps"
          mkdir -p "${PKG_DIR}/usr/share/icons/hicolor/64x64/apps"
          mkdir -p "${PKG_DIR}/usr/share/icons/hicolor/48x48/apps"
          mkdir -p "${PKG_DIR}/usr/share/doc/rustconn"
          
          # Binaries
          cp target/release/rustconn "${PKG_DIR}/usr/bin/"
          cp target/release/rustconn-cli "${PKG_DIR}/usr/bin/"
          
          # Desktop file and metadata
          cp rustconn/assets/io.github.totoshko88.RustConn.desktop "${PKG_DIR}/usr/share/applications/"
          cp rustconn/assets/io.github.totoshko88.RustConn.metainfo.xml "${PKG_DIR}/usr/share/metainfo/"
          
          # Icons
          cp rustconn/assets/icons/hicolor/scalable/apps/io.github.totoshko88.RustConn.svg \
             "${PKG_DIR}/usr/share/icons/hicolor/scalable/apps/" || true
          for size in 256 128 64 48; do
            cp "rustconn/assets/icons/hicolor/${size}x${size}/apps/io.github.totoshko88.RustConn.png" \
               "${PKG_DIR}/usr/share/icons/hicolor/${size}x${size}/apps/" 2>/dev/null || true
          done
          
          # Docs
          cp README.md LICENSE CHANGELOG.md "${PKG_DIR}/usr/share/doc/rustconn/"
          
          # Control file
          cat > "${PKG_DIR}/DEBIAN/control" << EOF
          Package: rustconn
          Version: ${VERSION}
          Section: net
          Priority: optional
          Architecture: amd64
          Depends: libgtk-4-1 (>= 4.14), libvte-2.91-gtk4-0, libadwaita-1-0, openssh-client
          Recommends: freerdp2-x11, tigervnc-viewer, virt-viewer
          Maintainer: Anton Isaiev <totoshko88@gmail.com>
          Description: Modern connection manager for Linux
           RustConn is a GTK4-based connection manager for SSH, RDP, VNC, and SPICE
           remote connections with support for embedded terminals, connection groups,
           import/export, and secure credential storage.
          EOF
          
          # Build deb
          dpkg-deb --build "${PKG_DIR}"
          mkdir -p dist
          mv "${PKG_DIR}.deb" dist/

      - name: Upload deb artifact
        uses: actions/upload-artifact@v4
        with:
          name: debian-package
          path: dist/*.deb

  build-appimage:
    name: Build AppImage
    runs-on: ubuntu-24.04
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            libgtk-4-dev \
            libvte-2.91-gtk4-dev \
            libadwaita-1-dev \
            libdbus-1-dev \
            libssl-dev \
            pkg-config \
            libfuse2

      - name: Build release
        run: cargo build --release -p rustconn -p rustconn-cli

      - name: Download linuxdeploy
        run: |
          wget -q https://github.com/linuxdeploy/linuxdeploy/releases/download/continuous/linuxdeploy-x86_64.AppImage
          wget -q https://raw.githubusercontent.com/linuxdeploy/linuxdeploy-plugin-gtk/master/linuxdeploy-plugin-gtk.sh
          chmod +x linuxdeploy-x86_64.AppImage linuxdeploy-plugin-gtk.sh

      - name: Prepare AppDir
        run: |
          mkdir -p AppDir/usr/bin
          mkdir -p AppDir/usr/share/applications
          mkdir -p AppDir/usr/share/icons/hicolor/scalable/apps
          mkdir -p AppDir/usr/share/icons/hicolor/256x256/apps
          mkdir -p AppDir/usr/share/icons/hicolor/128x128/apps
          mkdir -p AppDir/usr/share/icons/hicolor/64x64/apps
          mkdir -p AppDir/usr/share/icons/hicolor/48x48/apps
          mkdir -p AppDir/usr/share/metainfo
          
          cp target/release/rustconn AppDir/usr/bin/
          cp target/release/rustconn-cli AppDir/usr/bin/
          cp rustconn/assets/io.github.totoshko88.RustConn.desktop AppDir/usr/share/applications/
          cp rustconn/assets/io.github.totoshko88.RustConn.metainfo.xml AppDir/usr/share/metainfo/
          
          # Copy icons
          cp rustconn/assets/icons/hicolor/scalable/apps/io.github.totoshko88.RustConn.svg \
             AppDir/usr/share/icons/hicolor/scalable/apps/ || true
          for size in 256 128 64 48; do
            cp "rustconn/assets/icons/hicolor/${size}x${size}/apps/io.github.totoshko88.RustConn.png" \
               "AppDir/usr/share/icons/hicolor/${size}x${size}/apps/" 2>/dev/null || true
          done

      - name: Build AppImage
        run: |
          DEPLOY_GTK_VERSION=4 ./linuxdeploy-x86_64.AppImage \
            --appdir AppDir \
            --plugin gtk \
            --output appimage
          
          # Rename to include version
          VERSION=$(grep '^version' Cargo.toml | head -1 | sed 's/.*"\(.*\)"/\1/')
          mv RustConn*.AppImage "RustConn-${VERSION}-x86_64.AppImage"

      - name: Upload AppImage artifact
        uses: actions/upload-artifact@v4
        with:
          name: appimage
          path: "*.AppImage"

  release:
    name: Create Release
    needs: [build-deb, build-appimage]
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/')
    permissions:
      contents: write
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Download deb artifact
        uses: actions/download-artifact@v4
        with:
          name: debian-package
          path: dist/

      - name: Download AppImage artifact
        uses: actions/download-artifact@v4
        with:
          name: appimage
          path: dist/

      - name: Get version from tag
        id: version
        run: echo "VERSION=${GITHUB_REF#refs/tags/v}" >> $GITHUB_OUTPUT

      - name: Extract changelog for version
        id: changelog
        run: |
          VERSION=${{ steps.version.outputs.VERSION }}
          # Extract changelog section for this version
          awk -v ver="## \\[${VERSION}\\]" '
            $0 ~ ver {found=1; next}
            found && /^## \[/ {exit}
            found {print}
          ' CHANGELOG.md > version_changelog.md
          
          # If no changelog found, use default message
          if [ ! -s version_changelog.md ]; then
            echo "Release ${VERSION}" > version_changelog.md
          fi

      - name: Generate release notes
        id: notes
        run: |
          VERSION=${{ steps.version.outputs.VERSION }}
          cat << 'HEADER' > release_notes.md
          ## What's Changed
          
          HEADER
          
          cat version_changelog.md >> release_notes.md
          
          cat << EOF >> release_notes.md
          
          ## Installation

          ### Debian/Ubuntu
          \`\`\`bash
          sudo dpkg -i rustconn_${VERSION}_amd64.deb
          sudo apt-get install -f  # Install dependencies if needed
          \`\`\`

          ### AppImage
          \`\`\`bash
          chmod +x RustConn-${VERSION}-x86_64.AppImage
          ./RustConn-${VERSION}-x86_64.AppImage
          \`\`\`

          ### openSUSE (OBS)
          Packages available at: https://build.opensuse.org/package/show/home:totoshko88:rustconn/rustconn

          \`\`\`bash
          # Tumbleweed
          sudo zypper ar https://download.opensuse.org/repositories/home:/totoshko88:/rustconn/openSUSE_Tumbleweed/ rustconn
          sudo zypper ref
          sudo zypper in rustconn

          # Leap 16.0
          sudo zypper ar https://download.opensuse.org/repositories/home:/totoshko88:/rustconn/16.0/ rustconn
          sudo zypper ref
          sudo zypper in rustconn
          \`\`\`
          EOF

      - name: List artifacts
        run: ls -la dist/

      - name: Create Release
        uses: softprops/action-gh-release@v2
        with:
          files: dist/*
          body_path: release_notes.md
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
