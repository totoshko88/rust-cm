name: Publish to OBS

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:

env:
  OBS_PROJECT: home:${{ vars.OBS_USERNAME }}:rustconn
  OBS_PACKAGE: rustconn

jobs:
  trigger-obs:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install osc
        run: |
          sudo apt-get update
          sudo apt-get install -y osc

      - name: Configure osc
        run: |
          mkdir -p ~/.config/osc
          cat > ~/.config/osc/oscrc << EOF
          [general]
          apiurl = https://api.opensuse.org

          [https://api.opensuse.org]
          user = ${{ vars.OBS_USERNAME }}
          pass = ${{ secrets.OBS_PASSWORD }}
          EOF

      - name: Trigger OBS rebuild
        run: |
          osc service remoterun ${{ env.OBS_PROJECT }} ${{ env.OBS_PACKAGE }}

  build-appimage:
    runs-on: ubuntu-22.04
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install Rust
        uses: dtolnay/rust-action@stable
        with:
          toolchain: stable

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            libgtk-4-dev \
            libvte-2.91-gtk4-dev \
            libdbus-1-dev \
            libssl-dev \
            pkg-config

      - name: Build release
        run: cargo build --release -p rustconn -p rustconn-cli

      - name: Install appimage-builder
        run: |
          sudo apt-get install -y python3-pip python3-setuptools patchelf desktop-file-utils libgdk-pixbuf2.0-dev fakeroot strace
          pip3 install appimage-builder

      - name: Prepare AppDir
        run: |
          mkdir -p AppDir/usr/bin
          mkdir -p AppDir/usr/share/applications
          mkdir -p AppDir/usr/share/icons/hicolor/scalable/apps
          
          cp target/release/rustconn AppDir/usr/bin/
          cp target/release/rustconn-cli AppDir/usr/bin/
          cp rustconn/assets/org.rustconn.RustConn.desktop AppDir/usr/share/applications/
          
          # Copy icons if they exist
          if [ -d "rustconn/assets/icons" ]; then
            cp -r rustconn/assets/icons/* AppDir/usr/share/icons/
          fi

      - name: Build AppImage
        run: |
          appimage-builder --recipe packaging/obs/AppImageBuilder.yml --skip-tests

      - name: Upload AppImage
        uses: actions/upload-artifact@v4
        with:
          name: RustConn-AppImage
          path: "*.AppImage"

      - name: Release AppImage
        if: startsWith(github.ref, 'refs/tags/')
        uses: softprops/action-gh-release@v1
        with:
          files: "*.AppImage"
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
