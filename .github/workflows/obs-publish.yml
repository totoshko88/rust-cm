name: Publish to OBS

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:

env:
  OBS_PROJECT: home:${{ vars.OBS_USERNAME }}:rustconn
  OBS_PACKAGE: rustconn

jobs:
  trigger-obs:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Validate OBS credentials
        run: |
          if [ -z "${{ vars.OBS_USERNAME }}" ]; then
            echo "::error::OBS_USERNAME variable is not set"
            echo "Go to Settings → Secrets and variables → Actions → Variables"
            exit 1
          fi
          if [ -z "${{ secrets.OBS_PASSWORD }}" ]; then
            echo "::error::OBS_PASSWORD secret is not set"
            echo "Go to Settings → Secrets and variables → Actions → Secrets"
            exit 1
          fi

      - name: Install osc
        run: |
          sudo apt-get update
          sudo apt-get install -y osc

      - name: Configure osc
        run: |
          mkdir -p ~/.config/osc
          cat > ~/.config/osc/oscrc << EOF
          [general]
          apiurl = https://api.opensuse.org

          [https://api.opensuse.org]
          user = ${{ vars.OBS_USERNAME }}
          pass = ${{ secrets.OBS_PASSWORD }}
          EOF

      - name: Trigger OBS rebuild
        run: |
          osc service remoterun ${{ env.OBS_PROJECT }} ${{ env.OBS_PACKAGE }}
