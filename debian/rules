#!/usr/bin/make -f

export CARGO_HOME = $(CURDIR)/debian/cargo_home

%:
	dh $@

override_dh_auto_build:
	tar --zstd -xf vendor.tar.zst
	mkdir -p .cargo
	cp cargo_config .cargo/config.toml
	cargo build --release --offline -p rustconn -p rustconn-cli --all-features

override_dh_auto_install:
	# Binaries
	install -Dm755 target/release/rustconn debian/rustconn/usr/bin/rustconn
	install -Dm755 target/release/rustconn-cli debian/rustconn/usr/bin/rustconn-cli
	# Desktop file
	install -Dm644 rustconn/assets/org.rustconn.RustConn.desktop \
		debian/rustconn/usr/share/applications/org.rustconn.RustConn.desktop
	# Icon
	install -Dm644 rustconn/assets/icons/hicolor/scalable/apps/org.rustconn.RustConn.svg \
		debian/rustconn/usr/share/icons/hicolor/scalable/apps/org.rustconn.RustConn.svg
	# AppStream metainfo
	install -Dm644 rustconn/assets/org.rustconn.RustConn.metainfo.xml \
		debian/rustconn/usr/share/metainfo/org.rustconn.RustConn.metainfo.xml
	# Screenshots for local AppStream
	install -d debian/rustconn/usr/share/doc/rustconn/screenshots
	install -Dm644 rustconn/assets/screenshots/main.png \
		debian/rustconn/usr/share/doc/rustconn/screenshots/main.png
	install -Dm644 rustconn/assets/screenshots/split.png \
		debian/rustconn/usr/share/doc/rustconn/screenshots/split.png
	install -Dm644 rustconn/assets/screenshots/rdp.png \
		debian/rustconn/usr/share/doc/rustconn/screenshots/rdp.png
	# Cleanup
	rm -rf vendor .cargo

override_dh_auto_test:
	true

override_dh_auto_clean:
	cargo clean || true
	rm -rf $(CARGO_HOME) vendor .cargo
